<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„Ù…Ø¹Ø© â€” ØºØ³ÙŠÙ„ Ø³ÙŠØ§Ø±Ø§Øª Ù…ØªÙ†Ù‚Ù„</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <style>
    :root{
      --bg1:#e6f7ff; --bg2:#f0fffb; --ink:#0f1a2b;
      --brand:#00aaff; --brand2:#00d2a0;
      --muted:#5f7aa3; --card:#ffffff; --line:#e6eef8;
      --brand-2:#0ea5e9;
    }
    *{box-sizing:border-box}
    body { font-family:"Tajawal",sans-serif; background:radial-gradient(1200px 700px at 80% -10%,var(--bg1),transparent 60%),linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--ink); margin:0; }
    .hero { text-align:center; padding:28px 16px 18px; background:linear-gradient(135deg,rgba(0,170,255,.12),rgba(0,210,160,.10)),linear-gradient(180deg,#ffffffaa,#ffffff66); border-bottom:1px solid var(--line); }
    .hero h1{margin:8px 0 6px;font-size:2.2rem}
    .hero p{margin:0;color:var(--muted)}
    .formWrap{max-width:920px;margin:14px auto;background:var(--card);padding:20px;border-radius:14px;border:1px solid var(--line);box-shadow:0 10px 28px rgba(0,0,0,.06)}
    fieldset{border:1px dashed var(--line);border-radius:12px;padding:14px;margin-bottom:12px}
    legend{color:var(--muted)}
    input,select{width:100%;padding:12px;margin-bottom:10px;border-radius:10px;border:1px solid var(--line);background:#f8fbff;color:var(--ink);outline:none}
    input:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(0,170,255,.15)}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.row-2{grid-template-columns:1fr}}
    .price{font-size:1.25rem;font-weight:800;color:var(--brand)}
    .inline-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{padding:12px 18px;border:none;border-radius:12px;cursor:pointer;font-weight:800}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.success{background:var(--brand2);color:#003326}
    .btn.light{background:#eef6ff;color:#0f3c6e}
    #statusBanner{background:#e9fff6;border:1px solid #c3f5e5;color:#085a46}
    .map-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
    .map-card{width:min(94vw,840px);background:var(--card);border-radius:14px;padding:12px;box-shadow:0 16px 40px rgba(0,0,0,.18);border:1px solid var(--line)}
    #map{width:100%;height:440px;border-radius:12px}
    .map-actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;align-items:center}
    .hint{color:var(--muted)}
    footer{text-align:center;color:var(--muted);padding:10px 0 24px}
    .subhint{font-size:.9rem;color:var(--muted);margin-top:-6px}
    .badge{display:inline-block;background:#eef6ff;border:1px solid #d7e8ff;border-radius:999px;padding:6px 10px;font-weight:700}
    .list{display:grid;gap:10px}
    .item{border:1px dashed var(--line);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
  <section class="hero">
    <img src="https://i.ibb.co/k2wtWBrW/unnamed.jpg" alt="Ø´Ø¹Ø§Ø± Ù„Ù…Ø¹Ø©" style="max-width:160px;display:block;margin:0 auto 8px;border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.06);">
    <h1>Ø§Ø­Ø¬Ø² ØºØ³ÙŠÙ„ Ø³ÙŠØ§Ø±ØªÙƒ Ø§Ù„Ø¢Ù†</h1>
    <p>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„ØŒ Ø­Ø¯Ù‘Ø¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŒ ÙˆØ«Ø¨Ù‘Øª Ø§Ù„Ø­Ø¬Ø² ÙÙˆØ±Ù‹Ø§.</p>
  </section>

  <div id="statusBanner" class="formWrap" style="display:none;">
    <p id="statusText" style="margin:0;font-weight:800;"></p>
  </div>

  <section class="container">
    <form class="formWrap" id="bookingForm">
      <!-- (1) Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ -->
      <fieldset><legend>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</legend>
        <input id="phone" name="phone" type="tel" required placeholder="9xxxxxxxx" inputmode="tel" autocomplete="tel">
      </fieldset>

      <!-- (2) Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
      <fieldset><legend>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</legend>
        <select id="carType" name="carType" required>
          <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</option>
          <option value="ØµØ§Ù„ÙˆÙ†">ØµØ§Ù„ÙˆÙ†</option>
          <option value="ÙÙˆØ±ÙˆÙŠÙ„">ÙÙˆØ±ÙˆÙŠÙ„</option>
        </select>
      </fieldset>

      <!-- (2.1 & 2.2) Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„ÙˆØ­Ø©: Ø±Ù‚Ù… + Ø±Ù…Ø² (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ) -->
      <fieldset><legend>Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</legend>
        <div class="row-2">
          <div>
            <label for="carNumber" class="subhint">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label>
            <input id="carNumber" name="carNumber" type="text" required placeholder="e.g., 1234" pattern="[0-9]{1,6}" inputmode="numeric">
          </div>
          <div>
            <label for="carCode" class="subhint">Ø±Ù…Ø²/Ø­Ø±Ù Ø§Ù„Ù„ÙˆØ­Ø© (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
            <input id="carCode" name="carCode" type="text" required placeholder="e.g., A" pattern="[A-Za-z]{1,2}" title="Ø£Ø¯Ø®Ù„ Ø­Ø±ÙÙ‹Ø§ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø£Ùˆ Ø­Ø±ÙÙŠÙ†">
          </div>
        </div>
      </fieldset>

      <!-- (3) Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„ -->
      <fieldset><legend>Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„</legend>
        <select id="package" name="package" required>
          <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„</option>
          <option value="external">ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ</option>
          <option value="both">ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ ÙˆØ¯Ø§Ø®Ù„ÙŠ</option>
        </select>
      </fieldset>

      <!-- (4) Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
      <fieldset><legend>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</legend>
        <input id="address" type="text" placeholder="Ø§Ù†Ù‚Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©" readonly required>
        <input type="hidden" id="lat" name="lat"><input type="hidden" id="lng" name="lng">
      </fieldset>

      <div id="priceSection" class="inline-actions">
        <p class="price">Ø§Ù„Ø³Ø¹Ø±: <span id="priceValue">0.00</span> Ø±.Ø¹</p>
        <button class="btn chip-primary" type="button" id="confirmBtn" data-check-hours-trigger>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²</button>
      </div>
      <p class="muted" id="queueHint" style="display:none;margin:6px 2px 0;"></p>
    </form>
  </section>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù…Ø¹ ?staff=1) -->
  <section class="formWrap" id="staffPanel" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
      <h2 style="margin:0">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù</h2>
      <span class="badge" id="activeCount">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø©: 0</span>
    </div>
    <div class="list" id="activeList"></div>
  </section>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
  <div class="map-backdrop" id="mapModal" aria-hidden="true">
    <div class="map-card">
      <div id="map" role="application" aria-label="Ø®Ø±ÙŠØ·Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©"></div>
      <div class="map-actions">
        <button class="btn" type="button" id="useMyLocationBtn">ğŸ“ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
        <button class="btn success" type="button" id="confirmLocationBtn">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        <button class="btn" type="button" id="closeMapBtn">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
        <span class="hint" id="pickedCoords"></span>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² -->
  <div class="map-backdrop" id="queueModal" aria-hidden="true">
    <div class="map-card">
      <h2 style="margin:0 0 8px;">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ âœ…</h2>
      <p class="muted" style="margin:0 0 8px;">
        ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„ØºØ³ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.
      </p>
      <p style="font-weight:700;margin:0 0 6px;">
        Ø±Ù‚Ù…Ùƒ ÙÙŠ Ø§Ù„ØªØ³Ù„Ø³Ù„:
        <span id="queueModalPosition"></span>
      </p>
      <p style="margin:0 0 16px;font-weight:700;">
        Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹
      </p>
      <button class="btn chip-primary" type="button" id="queueModalOkBtn" style="width:100%;">
        Ù…ÙˆØ§ÙÙ‚
      </button>
    </div>
  </div>

  <!-- Ù‚Ø³Ù… Ø§Ù„Ø¯ÙØ¹ -->
  <div class="formWrap" id="paymentSection" style="display:none;">
    <h2 style="margin-top:0">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯ÙØ¹</h2>
    <p style="color:var(--muted)">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ Ø±Ù‚Ù… 99036615.</p>
    <div class="inline-actions"><button class="btn primary" id="paymentButton" type="button">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button></div>
  </div>

  <footer>Â© Ù„Ù…Ø¹Ø© â€” Ø®Ø¯Ù…Ø© ØºØ³ÙŠÙ„ Ø³ÙŠØ§Ø±Ø§Øª Ù…ØªÙ†Ù‚Ù„Ø©</footer>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- 1) Firebase + Auth (Ù‚Ø¨Ù„ Ø£ÙŠ Ø³ÙƒØ±Ø¨Øª Ø³Ø§Ø¹Ø§Øª) -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC_kRUAmKIFQwWK0Xrr8PeebnQbWGauu34",
      authDomain: "wash-a7ef9.firebaseapp.com",
      projectId: "wash-a7ef9",
      storageBucket: "wash-a7ef9.firebasestorage.app",
      messagingSenderId: "244309029995",
      appId: "1:244309029995:web:b5cb0534edce26aac3ed2e"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.firestore();
    const auth = firebase.auth();
    auth.signInAnonymously()
      .then(()=>console.log('[auth] anonymous OK'))
      .catch(e => console.warn('[auth] anon error:', e));

    auth.onAuthStateChanged(u => {
      window.currentUID = u ? u.uid : null;
      if (typeof toggleConfirmEnabled === 'function') toggleConfirmEnabled();
    });
  </script>

  <!-- 2) initHours: Ù‚Ø±Ø§Ø¡Ø© / Ø§Ø´ØªØ±Ø§Ùƒ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ + Ø¶Ø¨Ø· Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù„Ø³Ø© -->
  <script>
  (function wait(cb){ 
    if (window.firebase && firebase.firestore) return cb();
    setTimeout(()=>wait(cb), 80);
  })(function initHours(){
    const STORAGE_KEY = "businessHoursV1";
    const HOURS_DOC = db.collection('config').doc('businessHours');

    function seed(hours){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(hours));
        sessionStorage.setItem('bhCloudSeeded','1');
        window.__bh_cloud_ready = true;
        window.dispatchEvent(new CustomEvent('business-hours-updated', { detail: hours }));
        console.log('[viewer-hours] seed -> ok');
      }catch(e){ console.warn('[viewer-hours] local seed failed', e); }
    }

    async function pullOnce(){
      try{
        const s = await HOURS_DOC.get();
        const d = s.exists && s.data();
        if (d && Array.isArray(d.hours) && d.hours.length === 7) seed(d.hours);
      }catch(e){ console.warn('[viewer-hours] pull', e); }
    }

    try{
      HOURS_DOC.onSnapshot(s=>{
        const d = s.data && s.data();
        if (s.exists && d && Array.isArray(d.hours) && d.hours.length === 7) seed(d.hours);
      });
    }catch(e){ console.warn('[viewer-hours] sub', e); }

    pullOnce();
  });
  </script>

  <!-- 3) Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø®Ø±ÙŠØ·Ø©/Ø³Ø¹Ø±/Ø­Ø¬Ø²/Ù„ÙˆØ­Ø© Ù…ÙˆØ¸Ù) -->
  <script>
    /* ====== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ====== */
    let map, marker, lastLatLng = null;
    let currentBookingId = null;
    let unsubscribeBooking = null;
       let isBookingSubmitting = false; 
    const ACTIVE_STATUSES = ['pending','confirmed','accepted'];
    const DONE_STATUSES = ['completed','rejected','declined','canceled'];

    $(function () {
      $('#address').on('click', openMapModal);
      $('#useMyLocationBtn').on('click', useMyCurrentLocation);
      $('#confirmLocationBtn').on('click', confirmPickedLocation);
      $('#closeMapBtn').on('click', closeMapModal);

      const queueModal = document.getElementById('queueModal');
      const queueOkBtn = document.getElementById('queueModalOkBtn');
      if (queueOkBtn) {
        queueOkBtn.addEventListener('click', closeQueueModal);
      }
      if (queueModal) {
        queueModal.addEventListener('click', (e) => {
          if (e.target.id === 'queueModal') closeQueueModal();
        });
      }

      $('#package').on('change', updatePrice);
      $('#carType').on('change', updatePrice);
      updatePrice();

      document.getElementById('confirmBtn').addEventListener('click', onConfirmBooking);
      document.getElementById('paymentButton').addEventListener('click', onCompletePayment);

      ['phone','package','carType','carNumber','carCode'].forEach(id => {
        document.getElementById(id).addEventListener('input', toggleConfirmEnabled);
        document.getElementById(id).addEventListener('change', toggleConfirmEnabled);
      });

      const codeInput = document.getElementById('carCode');
      codeInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g,'');
      });

      const params = new URLSearchParams(location.search);
      if (params.get('staff') === '1') {
        document.getElementById('staffPanel').style.display = 'block';
        subscribeActiveList();
      }
    });

    function calcPrice(pkg, car) {
      const bump = 0.30;
      if (!pkg || !car) return 0;
      if (car === 'ØµØ§Ù„ÙˆÙ†') {
        if (pkg === 'external') return 1.00 + bump;
        if (pkg === 'both')     return 1.50 + bump;
      }
      if (car === 'ÙÙˆØ±ÙˆÙŠÙ„') {
        if (pkg === 'external') return 1.50 + bump;
        if (pkg === 'both')     return 2.00 + bump;
      }
      return 0;
    }
    function updatePrice() {
      const pkg  = document.getElementById('package').value;
      const car  = document.getElementById('carType').value;
      const price = calcPrice(pkg, car);
      document.getElementById('priceValue').innerText = price.toFixed(2);
      toggleConfirmEnabled();
    }

    function toggleConfirmEnabled() {
      const phone = document.getElementById('phone').value.trim();
      const pkg   = document.getElementById('package').value;
      const car   = document.getElementById('carType').value;
      const carNumber = (document.getElementById('carNumber')?.value || '').trim();
      const carCode   = (document.getElementById('carCode')?.value || '').trim();
      const price = calcPrice(pkg, car);
      const hasLocation = !!document.getElementById('lat').value && !!document.getElementById('lng').value;
      document.getElementById('confirmBtn').disabled = !(price > 0 && phone && car && carNumber && carCode && hasLocation);
    }

    function openMapModal() {
      const modal = document.getElementById('mapModal');
      modal.style.display = 'flex';
      setTimeout(() => {
        if (!map) {
          map = L.map('map');
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          map.setView([23.5880, 58.3829], 12);
          tryLocateAndDraw();
          map.on('click', e => setMarker(e.latlng));
        }
        setTimeout(() => map.invalidateSize(), 60);
      }, 0);
    }

    function tryLocateAndDraw() {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(pos => {
        const userLatLng = [pos.coords.latitude, pos.coords.longitude];
        map.setView(userLatLng, 15);
        const blueIcon = L.divIcon({
          html: '<div style="width:20px;height:20px;background:#4285F4;border:3px solid white;border-radius:50%;box-shadow:0 0 6px rgba(66,133,244,0.8);"></div>',
          className: ""
        });
        L.marker(userLatLng, { icon: blueIcon }).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
        L.circle(userLatLng, { radius: 120, color: '#4285F4', fillColor: '#4285F4', fillOpacity: 0.2 }).addTo(map);
      }, () => {});
    }

    function setMarker(latlng) {
      lastLatLng = latlng;
      if (!marker) {
        marker = L.marker(latlng, { draggable: true }).addTo(map);
        marker.on('dragend', () => { lastLatLng = marker.getLatLng(); updatePickedCoordsText(); });
      } else {
        marker.setLatLng(latlng);
      }
      updatePickedCoordsText();
    }

    function updatePickedCoordsText() {
      if (!lastLatLng) return;
      document.getElementById('pickedCoords').textContent =
        `Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯: ${lastLatLng.lat.toFixed(6)}, ${lastLatLng.lng.toFixed(6)}`;
    }

    function confirmPickedLocation() {
      if (!lastLatLng) { alert('Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©.'); return; }
      document.getElementById('lat').value = lastLatLng.lat.toFixed(6);
      document.getElementById('lng').value = lastLatLng.lng.toFixed(6);
      document.getElementById('address').value = `${lastLatLng.lat.toFixed(6)}, ${lastLatLng.lng.toFixed(6)}`;
      toggleConfirmEnabled();
      closeMapModal();
    }

    function closeMapModal() {
      document.getElementById('mapModal').style.display = 'none';
    }

    // Ù†Ø§ÙØ°Ø© Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„
    function openQueueModal(position) {
      const modal = document.getElementById('queueModal');
      if (!modal) return;
      const posEl = document.getElementById('queueModalPosition');
      if (posEl) posEl.textContent = position;
      modal.style.display = 'flex';
    }

    function closeQueueModal() {
      const modal = document.getElementById('queueModal');
      if (modal) modal.style.display = 'none';
    }


    function useMyCurrentLocation() {
      if (!navigator.geolocation) {
        alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const ll = { lat: pos.coords.latitude, lng: pos.coords.longitude };

          if (map) {
            map.setView([ll.lat, ll.lng], 16);
            setMarker(ll);
          }

          document.getElementById('lat').value = ll.lat.toFixed(6);
          document.getElementById('lng').value = ll.lng.toFixed(6);
          document.getElementById('address').value = `${ll.lat.toFixed(6)}, ${ll.lng.toFixed(6)}`;
          updatePickedCoordsText();
          toggleConfirmEnabled();

          closeMapModal();
        },
        err => {
          console.error('Ø®Ø·Ø£ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', err);
          alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS ÙˆÙ…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…ØªØµÙØ­.');
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    function showBanner(msg) {
      const b = document.getElementById('statusBanner');
      const t = document.getElementById('statusText');
      t.textContent = msg;
      b.style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function subscribeToBooking(id) {
      if (unsubscribeBooking) unsubscribeBooking();
      unsubscribeBooking = db.collection('bookings').doc(id).onSnapshot(async snap => {
        const data = snap.data();
        if (!data) return;
        await updateQueuePositionBanner(id);

        if (data.status === 'accepted') {
          showBanner('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ ÙˆØ³ÙŠÙ‚ÙˆÙ… Ø§Ù„ÙØ±ÙŠÙ‚ Ø¨Ø§Ù„ØªÙˆØ¬Ù‡ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³ÙŠØ§Ø±Ø©');
        }
        if (data.status === 'completed') {
          showBanner('ØªÙ… Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø®Ø¯Ù…Ø©ØŒ Ø´ÙƒØ±Ù‹Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø±Ùƒ Ù„Ù†Ø§.');
        }
        if (data.status === 'rejected') {
          showBanner('Ù†Ø¹ØªØ°Ø±ØŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø¹Ø¯Ù… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯ÙØ¹.');
        }
      });
    }

    async function updateQueuePositionBanner(bookingId) {
      try {
        const snap = await db.collection('bookings')
          .orderBy('createdAtMs')
          .get();
        const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const actives = docs.filter(b => ACTIVE_STATUSES.includes(b.status));
        const index = actives.findIndex(d => d.id === bookingId);
        if (index >= 0) {
          const position = index + 1;
          const msg = `Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: ${position} Ù…Ù† ${actives.length}`;
          document.getElementById('queueHint').style.display = 'block';
          document.getElementById('queueHint').textContent = msg;
        } else {
          document.getElementById('queueHint').style.display = 'none';
        }
      } catch (e) {
        console.warn('queue calc error', e);
      }
    }

    function formatDateAr(dt){
      const days = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
      const d = days[dt.getDay()];
      const hh = String(dt.getHours()).padStart(2,"0");
      const mm = String(dt.getMinutes()).padStart(2,"0");
      return `${d} ${hh}:${mm}`;
    }

    async function onConfirmBooking(ev) {
  ev.preventDefault();

  // Ù„Ùˆ Ø§Ù„Ø·Ù„Ø¨ Ø£ØµÙ„Ø§Ù‹ Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø¶ØºØ· Ø¥Ø¶Ø§ÙÙŠ
  if (isBookingSubmitting) {
    return;
  }

  const btn = document.getElementById('confirmBtn');

  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
  if (!window.__bh_cloud_ready) {
    alert('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...');
    return;
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø·Ù„Ø¨ Ø¯Ø§Ø®Ù„ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„
  if (window.businessHours && typeof window.businessHours.isOpenAt === 'function') {
    const nowDate = new Date();
    if (!window.businessHours.isOpenAt(nowDate)) {
      const next = window.businessHours.nextOpen ? window.businessHours.nextOpen(nowDate) : null;
      alert(next ? `Ø®Ø§Ø±Ø¬ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¢Ù†.\nÙ†Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ: ${formatDateAr(next)}.` : "Ø®Ø§Ø±Ø¬ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¢Ù†.");
      return;
    }
  }

  const form = document.getElementById('bookingForm');
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }
  if (!document.getElementById('lat').value || !document.getElementById('lng').value) {
    alert('ÙØ¶Ù„Ø§Ù‹ Ø­Ø¯Ù‘Ø¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©.');
    return;
  }
  if (!document.getElementById('package').value) {
    alert('ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„.');
    return;
  }
  if (!document.getElementById('carType').value) {
    alert('ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©.');
    return;
  }

  // Ø¨Ø¹Ø¯ ÙƒÙ„ Ø§Ù„ÙØ­ÙˆØµØ§ØªØŒ Ù†Ø¨Ø¯Ø£ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆÙ†Ù‚ÙÙ„ Ø§Ù„Ø²Ø±
  isBookingSubmitting = true;
  const originalText = btn.textContent;
  btn.dataset.originalText = originalText;
  btn.disabled = true;
  btn.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²...';

  const nowMs = Date.now();
  const booking = {
    phone: document.getElementById('phone').value.trim(),
    package: document.getElementById('package').value,
    carType: document.getElementById('carType').value,
    carNumber: document.getElementById('carNumber').value.trim(),
    carCode: document.getElementById('carCode').value.trim().toUpperCase(),
    address: document.getElementById('address').value.trim(),
    lat: document.getElementById('lat').value || null,
    lng: document.getElementById('lng').value || null,
    price: parseFloat(document.getElementById('priceValue').innerText) || 0,
    status: 'pending',
    createdAt: new Date(nowMs).toISOString(),
    createdAtMs: nowMs
  };

  try {
    // Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø² ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³
    const docRef = await db.collection('bookings').add(booking);
    currentBookingId = docRef.id;

    // Ø­Ø³Ø§Ø¨ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø¬Ø² ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const snap = await db.collection('bookings')
      .orderBy('createdAtMs')
      .get();
    const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    const actives = docs.filter(b => ACTIVE_STATUSES.includes(b.status));
    const index = actives.findIndex(d => d.id === currentBookingId);
    const position = (index >= 0) ? index + 1 : actives.length;

    const msg = `ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ âœ…. Ø±Ù‚Ù…Ùƒ ÙÙŠ Ø§Ù„ØªØ³Ù„Ø³Ù„: ${position}`;

    // Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
    showBanner(msg);

    // Ø§Ù„Ù†Øµ Ø£Ø³ÙÙ„ Ø§Ù„ÙÙˆØ±Ù…
    const queueHintEl = document.getElementById('queueHint');
    if (queueHintEl) {
      queueHintEl.style.display = 'block';
      queueHintEl.textContent =
        `Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: ${position} Ù…Ù† ${actives.length}`;
    }

    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ù„Ø³Ù„ (Ù„Ø§ ØªØ®ØªÙÙŠ Ø¥Ù„Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ù…ÙˆØ§ÙÙ‚")
    openQueueModal(position);


    // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²
    subscribeToBooking(currentBookingId);

    // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ø¯ÙØ¹
    document.getElementById('paymentSection').style.display = 'block';
    document.getElementById('paymentSection').scrollIntoView({ behavior: 'smooth' });

  } catch (err) {
    console.error('Save error:', err);
    alert('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø².\n' + (err && err.message ? err.message : ''));
  } finally {
    // Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø²Ø± Ù„ÙˆØ¶Ø¹Ù‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
    isBookingSubmitting = false;
    if (btn) {
      btn.disabled = false;
      btn.textContent = btn.dataset.originalText || 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²';
    }
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‚ÙŠÙŠÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø­Ø³Ø¨ Ø§Ù„Ø­Ù‚ÙˆÙ„
    toggleConfirmEnabled();
  }
}


    async function onCompletePayment() {
      try {
        if (!currentBookingId) { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¬Ø² Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯.'); return; }

        await db.collection('bookings').doc(currentBookingId).update({
          status: 'confirmed',
          paidAt: new Date().toISOString()
        });

        const btn = document.getElementById('paymentButton');
        btn.textContent = 'ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…';
        btn.classList.remove('primary');
        btn.classList.add('success');
        btn.disabled = true;

        alert('ØªÙ… Ø§Ù„Ø¯ÙØ¹ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­ âœ…');
        document.getElementById('paymentSection').style.display = 'block';

        await updateQueuePositionBanner(currentBookingId);
      } catch (err) {
        console.error('Confirm error:', err);
        alert('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹.\n' + (err && err.message ? err.message : ''));
      }
    }

    let unsubscribeActiveList = null;
    function subscribeActiveList() {
      if (unsubscribeActiveList) unsubscribeActiveList();
      unsubscribeActiveList = db.collection('bookings')
        .orderBy('createdAtMs')
        .onSnapshot(snap => {
          const docs = [];
          snap.forEach(doc => docs.push({id: doc.id, ...doc.data()}));
          const actives = docs.filter(b => ACTIVE_STATUSES.includes(b.status));
          document.getElementById('activeCount').textContent = `Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø©: ${actives.length}`;

          const list = document.getElementById('activeList');
          list.innerHTML = '';
          actives.forEach((b, i) => {
            const el = document.createElement('div');
            el.className = 'item';
            el.innerHTML = `
              <div style="min-width:0">
                <div style="font-weight:800">#${i+1} â€” ${b.carCode || ''} ${b.carNumber || ''} â€¢ ${b.carType || ''}</div>
                <div class="muted" style="font-size:.95rem">${b.package === 'both' ? 'Ø®Ø§Ø±Ø¬ÙŠ ÙˆØ¯Ø§Ø®Ù„ÙŠ' : 'Ø®Ø§Ø±Ø¬ÙŠ ÙÙ‚Ø·'} â€¢ ${b.phone} â€¢ ${new Date(b.createdAt).toLocaleString('ar')}</div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn light" onclick="staffAccept('${b.id}')">Ø¨Ø¯Ø¡ / Ù‚Ø¨ÙˆÙ„</button>
                <button class="btn success" onclick="staffComplete('${b.id}')">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</button>
                <button class="btn" onclick="staffReject('${b.id}')">Ø±ÙØ¶ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
              </div>
            `;
            list.appendChild(el);
          });
        }, err => {
          console.error('active list error', err);
        });
    }

    async function staffAccept(id) {
      try {
        await db.collection('bookings').doc(id).update({ status: 'accepted', acceptedAt: new Date().toISOString() });
      } catch (e) { console.error(e); alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©.\n' + (e && e.message ? e.message : '')); }
    }
    async function staffComplete(id) {
      try {
        await db.collection('bookings').doc(id).update({ status: 'completed', completedAt: new Date().toISOString() });
      } catch (e) { console.error(e); alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©.\n' + (e && e.message ? e.message : '')); }
    }
    async function staffReject(id) {
      try {
        await db.collection('bookings').doc(id).update({ status: 'rejected', rejectedAt: new Date().toISOString() });
      } catch (e) { console.error(e); alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©.\n' + (e && e.message ? e.message : '')); }
    }
  </script>

  <!-- ===== Mega Outside-Hours Notice ===== -->
  <style>
    .vh-banner{ display: none !important; }
    .vh-mega-backdrop{
      position: fixed; inset: 0; background: rgba(2,6,23,.45); backdrop-filter: blur(2px);
      display: none; z-index: 100000;
    }
    .vh-mega{
      position: fixed; z-index: 100001; top: 24px; left: 50%; transform: translateX(-50%);
      width: min(960px, 96vw); display: none; direction: rtl;
      background: #ffffff;
      border-radius: 18px;
      padding: 18px 20px;
      box-shadow: 0 30px 90px rgba(2,6,23,.35), 0 0 0 4px rgba(239, 68, 68, .10) inset;
      border: 1px solid #f1f5f9;
      animation: vhSlideDown .4s ease, vhGlow 2.2s ease-in-out infinite;
    }
    @keyframes vhSlideDown{
      from { transform: translate(-50%, -12px); opacity: 0; }
      to   { transform: translate(-50%, 0); opacity: 1; }
    }
    @keyframes vhGlow{
      0%,100% { box-shadow: 0 30px 90px rgba(2,6,23,.35), 0 0 0 4px rgba(239, 68, 68, .10) inset; }
      50%     { box-shadow: 0 30px 90px rgba(2,6,23,.35), 0 0 0 6px rgba(239, 68, 68, .20) inset; }
    }
    .vh-mega-wrap{
      display: grid; grid-template-columns: 72px 1fr auto; gap: 16px; align-items: center;
    }
    .vh-mega-icon{
      width: 72px; height: 72px; border-radius: 16px;
      background: radial-gradient(120% 120% at 100% 0%, #fee2e2 0%, #fff1f2 45%, #ffffff 100%);
      display: grid; place-items: center;
      box-shadow: inset 0 0 0 2px #fecaca;
    }
    .vh-mega-icon svg{ width: 40px; height: 40px; color: #ef4444; }
    .vh-mega-title{
      font: 800 20px/1.2 'Tajawal', system-ui; color: #0f172a; margin-bottom: 6px;
    }
    .vh-mega-line{
      display: flex; flex-wrap: wrap; align-items: center; gap: 10px;
      font: 700 16px/1.6 'Tajawal', system-ui; color: #334155;
    }
    .vh-mega-count{
      font: 800 16px 'Tajawal', system-ui; color: #ef4444; background: #fff1f2; border-radius: 999px;
      padding: 4px 10px; border: 1px solid #ffe4e6;
    }
    .vh-mega-progress{
      height: 8px; background: #f1f5f9; border-radius: 999px; overflow: hidden; margin-top: 10px;
    }
    .vh-mega-progress > span{
      display:block; width: 100%; height: 100%;
      background: repeating-linear-gradient(90deg, #fecaca 0 16px, #fee2e2 16px 32px);
      animation: vhProgress 1.3s linear infinite;
    }
    @keyframes vhProgress{
      from { transform: translateX(0); }
      to   { transform: translateX(-32px); }
    }
    .vh-mega-close{
      background: #0f172a; color: #fff; border: none; border-radius: 10px; cursor: pointer;
      padding: 10px 12px; font: 800 14px 'Tajawal', system-ui;
    }
    .vh-mega-sub{ font: 600 13px 'Tajawal', system-ui; color: #475569; }
    @media (max-width: 600px){
      .vh-mega-wrap{ grid-template-columns: 56px 1fr auto; }
      .vh-mega-icon{ width:56px; height:56px; }
      .vh-mega-icon svg{ width:32px; height:32px; }
      .vh-mega-title{ font-size: 18px; }
      .vh-mega-line{ font-size: 15px; }
      .vh-mega-count{ font-size: 15px; }
    }
  </style>

  <div class="vh-mega-backdrop" id="vhMegaBackdrop"></div>
  <div class="vh-mega" id="vhMega" role="alert" aria-live="assertive">
    <div class="vh-mega-wrap">
      <div class="vh-mega-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="9" stroke-width="2"/>
          <path d="M12 7v5l3 3" stroke-width="2" />
        </svg>
      </div>
      <div>
        <div class="vh-mega-title">Ø§Ù„Ø¢Ù† Ø®Ø§Ø±Ø¬ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„</div>
        <div class="vh-mega-line">
          <span id="vhMegaMsg">Ø³ØªÙØ³ØªØ£Ù†Ù Ø§Ù„Ø®Ø¯Ù…Ø© Ù‚Ø±ÙŠØ¨Ù‹Ø§â€¦</span>
          <span class="vh-mega-count" id="vhMegaCount">â€”:â€”:â€”</span>
        </div>
        <div class="vh-mega-progress" aria-hidden="true"><span></span></div>
        <div class="vh-mega-sub" id="vhMegaSub"></div>
      </div>
      <button class="vh-mega-close" id="vhMegaClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <script>
  (function(){
    const STORAGE_KEY = "businessHoursV1";
    const mapJsToOur = {6:0, 0:1, 1:2, 2:3, 3:4, 4:5, 5:6};

    function loadHours(){
      try{
        if(window.businessHours && window.businessHours.load) return window.businessHours.load();
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        const parsed = JSON.parse(raw);
        return (Array.isArray(parsed) && parsed.length===7) ? parsed : null;
      }catch(e){ return null; }
    }
    function toMinutes(t){ if(!t) return null; const [H,M] = t.split(":").map(Number); return H*60+M; }
    function isInRange(mins, from, to){ const f=toMinutes(from), tt=toMinutes(to); return f!=null && tt!=null && mins>=f && mins<=tt; }

    function isOpenAt(date, hours){
      if(!hours) return true;
      const idx = mapJsToOur[date.getDay()];
      const h = hours[idx];
      if(!h || h.closed) return false;
      const curMins = date.getHours()*60 + date.getMinutes();
      if(h.p1 && h.p1.from && h.p1.to && isInRange(curMins, h.p1.from, h.p1.to)) return true;
      if(h.p2 && h.p2.enabled && h.p2.from && h.p2.to && isInRange(curMins, h.p2.from, h.p2.to)) return true;
      return false;
    }

    function nextOpenDate(fromDate, hours){
      if(!hours) return null;
      const d = new Date(fromDate.getTime());
      for(let i=0;i<14;i++){
        const idx = mapJsToOur[d.getDay()];
        const h = hours[idx];
        if(h && !h.closed){
          const curMins = d.getHours()*60 + d.getMinutes();
          const p1f = toMinutes(h.p1 && h.p1.from), p2f = toMinutes(h.p2 && h.p2.from);
          if(i===0){
            if(p1f!=null && curMins < p1f){ const nd=new Date(d); nd.setHours(Math.floor(p1f/60), p1f%60,0,0); return nd; }
            if(h.p2 && h.p2.enabled && p2f!=null && curMins < p2f){ const nd=new Date(d); nd.setHours(Math.floor(p2f/60), p2f%60,0,0); return nd; }
          }else{
            if(p1f!=null){ const nd=new Date(d); nd.setHours(Math.floor(p1f/60), p1f%60,0,0); return nd; }
            if(h.p2 && h.p2.enabled && p2f!=null){ const nd=new Date(d); nd.setHours(Math.floor(p2f/60), p2f%60,0,0); return nd; }
          }
        }
        d.setDate(d.getDate()+1); d.setHours(0,0,0,0);
      }
      return null;
    }

    function fmtAbs(dt){
      const days = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
      const dd = days[dt.getDay()];
      const hh = String(dt.getHours()).padStart(2,"0");
      const mm = String(dt.getMinutes()).padStart(2,"0");
      return `${dd} ${hh}:${mm}`;
    }
    function fmtDelta(ms){
      if(ms<=0) return "00:00:00";
      let s = Math.floor(ms/1000);
      const h = Math.floor(s/3600); s -= h*3600;
      const m = Math.floor(s/60); s -= m*60;
      const pad = n=>String(n).padStart(2,"0");
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    const mega = document.getElementById("vhMega");
    const backdrop = document.getElementById("vhMegaBackdrop");
    const msg = document.getElementById("vhMegaMsg");
    const count = document.getElementById("vhMegaCount");
    const sub = document.getElementById("vhMegaSub");
    const btnClose = document.getElementById("vhMegaClose");

    let dismissed = false;
    btnClose.addEventListener("click", ()=>{ dismissed = true; mega.style.display = "none"; backdrop.style.display="none"; });

    function updateMega(){
      const hours = loadHours();
      const now = new Date();
      if(isOpenAt(now, hours)){ dismissed=false; mega.style.display="none"; backdrop.style.display="none"; return; }
      const next = nextOpenDate(now, hours);
      if(dismissed) return;
      msg.textContent = next ? `Ø³ØªÙØ³ØªØ£Ù†Ù Ø§Ù„Ø®Ø¯Ù…Ø© ÙÙŠ: ${fmtAbs(next)}` : "Ø®Ø§Ø±Ø¬ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„.";
      if(next){
        const diff = next.getTime()-now.getTime();
        count.textContent = fmtDelta(diff);
        sub.textContent = "Ù„Ù† ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„.";
      }else{
        count.textContent = "â€”:â€”:â€”";
        sub.textContent = "Ù„Ù† ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†.";
      }
      mega.style.display = "block";
      backdrop.style.display = "block";
    }

    updateMega();
    setInterval(updateMega, 1000);
    window.addEventListener("business-hours-updated", updateMega);
  })();
  </script>

  <!-- ===== Firestore sync + Cloud-Only (INDEX, compat) ===== -->
  <script>
  (function(){
    const STORAGE_KEY = "businessHoursV1";
    if(!(window.firebase && firebase.firestore)){ console.warn("[index-hours] Firebase not found"); return; }
    window.db = window.db || firebase.firestore();
    const HOURS_DOC = db.collection('config').doc('businessHours');

    try{
      if(!sessionStorage.getItem("bhCloudSeeded")){
        console.log("[index-hours] waiting for cloud seed; keeping local cache");
      }
    }catch(_){}

    window.__bh_cloud_ready = false;

    async function seedFromCloud(){
      try{
        const snap = await HOURS_DOC.get();
        const d = snap.exists && snap.data();
        if(d && Array.isArray(d.hours) && d.hours.length===7){
          localStorage.setItem(STORAGE_KEY, JSON.stringify(d.hours));
          window.__bh_cloud_ready = true;
          sessionStorage.setItem("bhCloudSeeded","1");
          window.dispatchEvent(new CustomEvent("business-hours-updated", { detail: d.hours }));
          console.log("[index-hours] seeded from cloud");
        }
      }catch(e){ console.warn("[index-hours] seed error:", e); }
    }

    try{
      HOURS_DOC.onSnapshot((snap)=>{
        const d = snap.data && snap.data();
        if(snap.exists && d && Array.isArray(d.hours) && d.hours.length===7){
          localStorage.setItem(STORAGE_KEY, JSON.stringify(d.hours));
          window.__bh_cloud_ready = true;
          sessionStorage.setItem("bhCloudSeeded","1");
          window.dispatchEvent(new CustomEvent("business-hours-updated", { detail: d.hours }));
          console.log("[index-hours] live update");
        }
      });
    }catch(e){ console.warn("[index-hours] live sub failed:", e); }

    function block(e){
      if(!window.__bh_cloud_ready){
        e.preventDefault();
        alert("Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...");
        return true;
      }
      return false;
    }
    function attach(){
      document.querySelectorAll("form#bookingForm, form[data-check-hours], form.check-hours").forEach(f=>{
        if(f.__bh_cloudonly) return; f.__bh_cloudonly = true;
        f.addEventListener("submit", block, true);
      });
      document.querySelectorAll("[data-check-hours-trigger]").forEach(el=>{
        if(el.__bh_cloudonly) return; el.__bh_cloudonly = true;
        el.addEventListener("click", block, true);
      });
    }
    attach();
    new MutationObserver(attach).observe(document.documentElement,{childList:true,subtree:true});

    seedFromCloud();
  })();
  </script>

  <!-- ===== Ø®Ø¯Ù…Ø§ØªÙ†Ø§ â€” Ø²Ø± + Ù†Ø§ÙØ°Ø© Ù…ÙÙ†Ø³Ù‘Ù‚Ø© ===== -->
  <style>
    .chip-primary{
      display:inline-block;
      padding:8px 16px;
      border:none;
      border-radius:999px;
      font:800 13px 'Tajawal',system-ui;
      color:#fff;
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      box-shadow:0 8px 24px rgba(14,165,233,.35);
      line-height:1; white-space:nowrap;
    }
    .btn.chip-primary{
      padding:12px 20px;
      border-radius:999px;
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      color:#fff;
    }
  </style>

  <style>
    :root{
      --brand: #38bdf8;
      --brand-2: #0ea5e9;
      --fg: #0f172a;
      --card-bg: rgba(255,255,255,.92);
      --stroke: rgba(2,6,23,.08);
    }
    .svc-btn{
      position:fixed; z-index:10002; bottom:18px; left:18px;
      border:none; border-radius:999px; cursor:pointer;
      padding:12px 16px; color:#fff; font:800 14px 'Tajawal',system-ui;
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      box-shadow:0 10px 30px rgba(14,165,233,.35);
      transition:transform .15s ease, box-shadow .2s ease;
    }
    .svc-btn:hover{ transform:translateY(-1px); box-shadow:0 16px 36px rgba(14,165,233,.45); }

    .svc-modal-backdrop{ position:fixed; inset:0; background:rgba(15,23,42,.45); display:none; z-index:10001; }
    .svc-modal{ position:fixed; inset:0; display:none; place-items:center; z-index:10002; padding:16px; }

    .svc-card{
      width:min(720px,96vw); max-height:86vh; overflow:auto; direction:rtl;
      background:var(--card-bg); border:1px solid var(--stroke); border-radius:18px;
      box-shadow:0 24px 70px rgba(2,6,23,.28);
      backdrop-filter:saturate(140%) blur(12px);
      animation:svcPop .18s ease-out;
    }
    @keyframes svcPop{ from{ transform:scale(.98); opacity:0 } to{ transform:scale(1); opacity:1 } }

    .svc-hdr{ display:flex; justify-content:space-between; align-items:center; padding:14px 16px; position:sticky; top:0; background:linear-gradient(to bottom, rgba(255,255,255,.96), rgba(255,255,255,.88)); backdrop-filter:blur(6px); }
    .svc-title{ margin:0; font:800 18px 'Tajawal',system-ui; color:var(--fg); }
    .svc-close{ background:transparent; border:none; font-size:22px; cursor:pointer; line-height:1; color:#334155; }

    .svc-sub{ margin:6px 16px 10px; color: #475569; font:600 13px 'Tajawal',system-ui; display:flex; gap:8px; flex-wrap:wrap; }
    .svc-pill{ padding:4px 10px; border-radius:999px; border:1px solid var(--stroke); background:rgba(248,250,252,.8); }

    .svc-list{ margin:10px 16px 16px; padding:0; list-style:none; }
    .svc-li{ display:flex; gap:10px; align-items:flex-start; padding:10px 0; border-bottom:1px dashed var(--stroke); }
    .svc-li:last-child{ border-bottom:none; }
    .svc-ico{ flex:0 0 20px; height:20px; margin-top:2px; opacity:.85 }
    .svc-txt{ color:#0b1220; font:600 14px 'Tajawal',system-ui; }

    .svc-cta-row{
      position:sticky; bottom:0; display:flex; gap:10px; justify-content:flex-end; align-items:center;
      padding:12px 16px; background:linear-gradient(to top, rgba(255,255,255,.96), rgba(255,255,255,.88)); border-top:1px solid var(--stroke);
    }

    .svc-cta{
      display:inline-flex; align-items:center; gap:8px; text-decoration:none;
      padding:10px 14px; border-radius:12px; color:#fff; font:800 14px 'Tajawal',system-ui;
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      box-shadow:0 6px 20px rgba(14,165,233,.35);
    }
    .svc-ghost{ border:1px solid var(--stroke); background:#fff; color:#0b1220; border-radius:12px; padding:10px 14px; font:700 14px 'Tajawal',system-ui; }
    @media (max-width:380px){ .svc-title{ font-size:16px } .svc-txt{ font-size:13px } }
  </style>

  <button type="button" class="svc-btn" id="svcOpenBtn" title="Ø®Ø¯Ù…Ø§ØªÙ†Ø§">Ø®Ø¯Ù…Ø§ØªÙ†Ø§</button>
  <div class="svc-modal-backdrop" id="svcBackdrop"></div>

  <div class="svc-modal" id="svcModal" role="dialog" aria-modal="true" aria-labelledby="svcTitle">
    <div class="svc-card">
      <div class="svc-hdr">
        <h3 class="svc-title" id="svcTitle">Ø®Ø¯Ù…Ø§ØªÙ†Ø§ Ø§Ù„Ù…ØªÙ†Ù‚Ù„Ø©</h3>
        <button class="svc-close" id="svcCloseBtn" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
      </div>

      <div class="svc-sub">
        <span class="chip-primary">Ù†ÙˆØµÙ„ Ù„Ù…ÙˆÙ‚Ø¹Ùƒ</span>
        <span class="chip-primary">Ø­Ø¬Ø² Ø³Ø±ÙŠØ¹</span>
        <span class="chip-primary">Ø¯ÙØ¹ Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„</span>
      </div>

      <ul class="svc-list">
        <li class="svc-li">
          <svg class="svc-ico" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <div class="svc-txt">Ù„Ø§ ØªØ¬ÙŠ Ø¥Ø­Ù†Ø§ Ù†Ø¬ÙŠÙƒ</div>
        </li>
        <li class="svc-li">
          <svg class="svc-ico" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <div class="svc-txt">Ø§Ù„Ø­Ø¬Ø² Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„ 99036615</div>
        </li>
        <li class="svc-li">
          <svg class="svc-ico" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2"/></svg>
          <div class="svc-txt">ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ Ø³Ø±ÙŠØ¹: Ø´Ø·Ù + Ø±ØºÙˆØ© + ØªØ¬ÙÙŠÙ ÙŠØ¯ÙˆÙŠ.</div>
        </li>
        <li class="svc-li">
          <svg class="svc-ico" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2"/></svg>
          <div class="svc-txt">ØºØ³ÙŠÙ„ ÙƒØ§Ù…Ù„: Ø®Ø§Ø±Ø¬ÙŠ + ØªÙ†Ø¸ÙŠÙ Ø¯Ø§Ø®Ù„ÙŠ Ø£Ø³Ø§Ø³ÙŠ + ØªØ¹Ø·ÙŠØ±.</div>
        </li>
        <li class="svc-li">
          <svg class="svc-ico" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2"/></svg>
          <div class="svc-txt">Ø¹Ù†Ø§ÙŠØ© ÙØ§Ø®Ø±Ø©</div>
        </li>
      </ul>

      <div class="svc-cta-row">
        <button class="svc-ghost" id="svcCloseBtn2">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const openBtn = document.getElementById('svcOpenBtn');
      const closeBtn = document.getElementById('svcCloseBtn');
      const closeBtn2 = document.getElementById('svcCloseBtn2');
      const modal = document.getElementById('svcModal');
      const backdrop = document.getElementById('svcBackdrop');

      function open(){ backdrop.style.display='block'; modal.style.display='grid'; }
      function close(){ backdrop.style.display='none'; modal.style.display='none'; }

      openBtn.addEventListener('click', open);
      closeBtn.addEventListener('click', close);
      closeBtn2.addEventListener('click', close);
      backdrop.addEventListener('click', close);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
    })();
  </script>

</body>
</html>
